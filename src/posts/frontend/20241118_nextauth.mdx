---
title: NextAuth - UntrustedHost ì´í•´í•˜ê¸°
description: NextAuth.js v5ì—ì„œ ë§ˆì£¼ì¹˜ëŠ” UntrustedHost ì˜¤ë¥˜ì˜ ì›ì¸ê³¼ í•´ê²° ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤. trustHost ì˜µì…˜ ì„¤ì •ë¶€í„° X-Forwarded-Host í—¤ë”ì˜ ì—­í• , ê·¸ë¦¬ê³  ë¡œì»¬ í™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œì˜ ì˜¬ë°”ë¥¸ ì„¤ì • ë°©ë²•ê¹Œì§€ ìì„¸íˆ ë‹¤ë£¹ë‹ˆë‹¤.
date: 2024-11-18
---
## ë¬¸ì œ ìƒí™©

**NextAuth.js v5**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„ êµ¬í˜„í•˜ë˜ ì¤‘,  
ë¡œì»¬ í™˜ê²½ì—ì„œ í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

```bash
 [tk: Host must be trusted. URL was: http://localhost:3000/api/auth/session. Read more at https://errors.authjs.dev#untrustedhost] {
  name: 'tk',
  type: 'UntrustedHost',
  kind: 'error'
} []
```

## í•´ê²° ë°©ë²•
### TrustHost ì˜µì…˜ ì„¤ì •í•˜ê¸°

ì´ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ ë°©ë²• ì¤‘ í•˜ë‚˜ë¡œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ”—Â [Auth.js - UntrustedHost](https://authjs.dev/reference/core/errors#untrustedhost)

1. NextAuth ì„¤ì •ì—ì„œ ì§ì ‘ ì„¤ì •
    ```tsx
    export const authConfig = {
      ...
      trustHost: true,
      ...
    }
    ```

1. í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
    ```tsx
    AUTH_TRUST_HOST=TRUE
    ```

ì´ì œ ì´ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ì›ì¸ì— ëŒ€í•´ ì¢€ ë” ê¹Šì´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

## ê¸°ìˆ ì  ë°°ê²½
### **AUTH_TRUST_HOST**ë€?

ê³µì‹ ë¬¸ì„œì— ë”°ë¥´ë©´, **`AUTH_TRUST_HOST`** í™˜ê²½ ë³€ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

> When deploying your application behind a reverse proxy, youâ€™ll need to set `AUTH_TRUST_HOST` equal to true. This tells Auth.js to trust the `X-Forwarded-Host` header from the reverse proxy. Auth.js will automatically infer this to be true if we detect the environment variable indicating that your application is running on one of the supported hosting providers. Currently VERCEL and CF_PAGES (Cloudflare Pages) are supported.
> 

AUTH_TRUST_HOST ì„¤ì •ì€ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ í™˜ê²½ì—ì„œ íŠ¹íˆ ì¤‘ìš”í•©ë‹ˆë‹¤.  
ì´ ì„¤ì •ì´ í•„ìš”í•œ ì£¼ìš” ìƒí™©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì‚¬ìš© ì‹œ
- `X-Forwarded-Host` í—¤ë”ë¥¼ ì‚¬ìš©í•˜ëŠ” í™˜ê²½
- íŠ¹ì • í˜¸ìŠ¤íŒ… ì œê³µì—…ì²´ ì‚¬ìš© ì‹œ
  
  
### ìë™ í™œì„±í™” í™˜ê²½

ë‹¤ìŒ í˜¸ìŠ¤íŒ… í™˜ê²½ì—ì„œëŠ” `AUTH_TRUST_HOST`ê°€ ìë™ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤.

- Vercel
- Cloudflare Pages

### **X-Forwarded-Host í—¤ë”ì˜ ì—­í• **

- í´ë¼ì´ì–¸íŠ¸ì˜ ì›ë˜ ìš”ì²­ í˜¸ìŠ¤íŠ¸ ì •ë³´ë¥¼ í¬í•¨
- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ í™˜ê²½ì—ì„œ ì¤‘ìš”í•œ ì—­í• 
- ë¡œë“œ ë°¸ëŸ°ì„œë‚˜ í”„ë¡ì‹œ ì„œë²„ì—ì„œ ì£¼ë¡œ ì‚¬ìš©

## ë¡œì»¬ í™˜ê²½ì—ì„œì˜ **UntrustedHost** ì˜¤ë¥˜
### ë°œìƒ ì›ì¸

ë¡œì»¬ í™˜ê²½ì—ì„œ í”„ë¡œë•ì…˜ ëª¨ë“œ ì‹¤í–‰ ì‹œ **UntrustedHost ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ì´ìœ **
1. Next.jsì˜ ë‚´ë¶€ ë™ì‘
    1. ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œê°€ ì—†ì–´ë„ **`X-Forwarded-Host`** í—¤ë” ìë™ ì„¤ì •
2. NextAuthì˜ ë³´ì•ˆ ì •ì±…
    1. í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ í˜¸ìŠ¤íŠ¸ ê²€ì¦ ìˆ˜í–‰
    2. ëª…ì‹œì ì¸ ì‹ ë¢° ì„¤ì • ìš”êµ¬

### NextAuthì˜ ë‚´ë¶€ ë™ì‘

NextAuth v5ì˜ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¡œì§ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.

```tsx
// node_modules/@auth/core/src/lib/utils/env.ts

  config.trustHost ??= !!(
    envObject.AUTH_URL ??
    envObject.AUTH_TRUST_HOST ??
    envObject.VERCEL ??
    envObject.CF_PAGES ??
    envObject.NODE_ENV !== "production"
  )
```

ì´ ì½”ë“œëŠ” ë‹¤ìŒ ì¡°ê±´ë“¤ì„ í™•ì¸í•˜ì—¬ trustHost ê°’ì„ ê²°ì •í•©ë‹ˆë‹¤.

- AUTH_URL ì¡´ì¬ ì—¬ë¶€
- AUTH_TRUST_HOST ì„¤ì •
- Vercel í™˜ê²½
- Cloudflare Pages í™˜ê²½
- ê°œë°œ í™˜ê²½ ì—¬ë¶€

```tsx
// node_modules/@auth/core/src/lib/utils/assert.ts

export function assertConfig(request, options) {
    const { url } = request;
    const warnings = [];
    if (!warned && options.debug)
        warnings.push("debug-enabled");
    if (!options.trustHost) {
        return new UntrustedHost(`Host must be trusted. URL was: ${request.url}`);
    }
    
    ...
```

**X-Forwarded-Host** í—¤ë”ë¥¼ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ

```tsx
// node_modules/@auth/core/src/lib/utils/env.ts 

export function createActionURL(
  action: AuthAction,
  protocol: string,
  headers: Headers,
  envObject: any,
  config: Pick<AuthConfig, "basePath" | "logger">
): URL {
  const basePath = config?.basePath
  const envUrl = envObject.AUTH_URL ?? envObject.NEXTAUTH_URL

  let url: URL
  if (envUrl) {
    url = new URL(envUrl)
    if (basePath && basePath !== "/" && url.pathname !== "/") {
      if (url.pathname !== basePath) {
        const logger = setLogger(config)
        logger.warn("env-url-basepath-mismatch")
      }
      url.pathname = "/"
    }
  } else {
    const detectedHost = headers.get("x-forwarded-host") ?? headers.get("host")
    const detectedProtocol =
      headers.get("x-forwarded-proto") ?? protocol ?? "https"
    const _protocol = detectedProtocol.endsWith(":")
      ? detectedProtocol
      : detectedProtocol + ":"

    url = new URL(`${_protocol}//${detectedHost}`)
  }

  // remove trailing slash
  const sanitizedUrl = url.toString().replace(/\/$/, "")

  if (basePath) {
    // remove leading and trailing slash
    const sanitizedBasePath = basePath?.replace(/(^\/|\/$)/g, "") ?? ""
    return new URL(`${sanitizedUrl}/${sanitizedBasePath}/${action}`)
  }
  return new URL(`${sanitizedUrl}/${action}`)
}

```

ìŒ..? 

ì´ ì½”ë“œëŠ” **`X-Forwarded-Host`** í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì—¬ URLì„ ìƒì„±í•˜ëŠ” ìš©ë„ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

ì‘ì„±ëœ ê³µì‹ ë¬¸ì„œë¥¼ ë³´ì•˜ì„ ë•Œ, ì•„ë§ˆ v5 ì´ì „ ë²„ì „ì—ëŠ” x-forwarded-host ì™€ ì‹¤ì œ hostë¥¼ ë¹„êµí•˜ëŠ” ë³´ì•ˆ ê²€ì¦ì´ ìˆì—ˆë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

## ì‹¤ì œ ì ìš© ê°€ì´ë“œ

### ë¡œì»¬ ê°œë°œ í™˜ê²½

ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë³„ë„ ì„¤ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤. (`NODE_ENV !== "production"` ì¡°ê±´ìœ¼ë¡œ ì¸í•´)

### ë¡œì»¬ í”„ë¡œë•ì…˜ í…ŒìŠ¤íŠ¸

ë‹¤ìŒ ì¤‘ í•œ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.

```tsx
// .env

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
AUTH_TRUST_HOST=TRUE
```

ë˜ëŠ”

```tsx
// NextAuth ì„¤ì •

export const authConfig = {
  trustHost: true
}
```

### ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½

- Vercel/Cloudflare Pages
    - ì¶”ê°€ ì„¤ì • ë¶ˆí•„ìš” (ìë™ í™œì„±í™”)
- ê¸°íƒ€ í˜¸ìŠ¤íŒ… í™˜ê²½
    - í™˜ê²½ì— ë§ëŠ” ì ì ˆí•œ trustHost ì„¤ì • í•„ìš”
    - ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì‚¬ìš© ì‹œ ë°˜ë“œì‹œ í™œì„±í™”

## ê²°ë¡ 

NextAuth v5ì—ì„œì˜ UntrustedHost ë©”ì‹œì§€ëŠ” ë³´ì•ˆì„ ìœ„í•œ í˜¸ìŠ¤íŠ¸ ê²€ì¦ ì ˆì°¨ì˜ ì¼ë¶€ì…ë‹ˆë‹¤. 

ì´ëŠ” ì´ì „ ë²„ì „ê³¼ ë‹¬ë¦¬(ì¶”ì¸¡) `X-Forwarded-Host` í—¤ë” ê²€ì¦ê³¼ëŠ” ì§ì ‘ì ì¸ ê´€ë ¨ì´ ì—†ìœ¼ë©°, í™˜ê²½ ë³€ìˆ˜ë‚˜ ì„¤ì •ì„ í†µí•´ ì œì–´ë©ë‹ˆë‹¤.

íŠ¹íˆ ë¡œì»¬ì—ì„œ í”„ë¡œë•ì…˜ ëª¨ë“œ í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” `AUTH_TRUST_HOST=true` ì„¤ì •ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆìœ¼ë©°, ì‹¤ì œ ë°°í¬ í™˜ê²½ì—ì„œëŠ” í•´ë‹¹ í™˜ê²½ì— ë§ëŠ” ì ì ˆí•œ ì„¤ì •ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.