---
title: Next.js 15 Edge Runtimeì—ì„œ NextAuth v5ì™€ bcrypt í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°í•˜ê¸°
description: Next.js 14ì—ì„œ NextAuth v5ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ë§ˆì£¼ì¹œ Edge Runtimeê³¼ bcrypt í˜¸í™˜ì„± ì´ìŠˆë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì„ ë‹¤ë£¹ë‹ˆë‹¤. Node.js ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆì˜ Edge Runtime ì œì•½ì‚¬í•­ê³¼ ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì„¤ì • ë¶„ë¦¬ ë°©ë²•ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
date: 2024-11-13
---

## ë“¤ì–´ê°€ë©°

í˜„ì¬ ê°œë°œ ì¤‘ì¸ í”„ë¡œì íŠ¸ì—ì„œ NextAuth.js v5ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„ êµ¬í˜„í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì•¡ì„¸ìŠ¤ í† í°ê³¼ ë¦¬í”„ë ˆì‹œ í† í°ì„ í™œìš©í•œ ì¸ì¦ ì‹œìŠ¤í…œì—ì„œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™”ë¥¼ ìœ„í•´ bcryptë¥¼ ì‚¬ìš©í•˜ë˜ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

## ë¬¸ì œ ìƒí™©
ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ë¥¼ êµ¬í˜„í•˜ë˜ ì¤‘, ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

```tsx showLineNumbers
// src/lib/auth.ts

import NextAuth from "next-auth"
import Credentials from "next-auth/providers/credentials"
 
export const { handlers, signIn, signOut, auth } = NextAuth({
  providers: [
    Credentials({
      credentials: {
        email: {},
        password: {},
      },
      authorize: async (credentials) => {
 
        // ì‚¬ìš©ì ì •ë³´ë¥¼ DBë¡œë¶€í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        const user = await getUserFromDb(credentials.email, password)
 
        if (!user) {
          throw new Error("Invalid credentials.")
        }

        return user
      },
    }),
  ],
})
```

```tsx showLineNumbers
// src/middleware.ts

import { NextResponse } from "next/server"
import type { NextRequest } from "next/server"
import { auth, signOut } from "@/lib/auth"

export async function middleware(request: NextRequest) {
  const session = await auth()
  if (session?.error === "RefreshToken expired") {
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    await signOut()

    // í˜„ì¬ URLì„ stateë¡œ ì €ì¥í•˜ì—¬ ë¡œê·¸ì¸ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ìˆ˜ ìˆë„ë¡ í•¨
    const callbackUrl = encodeURIComponent(request.url)

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return NextResponse.redirect(
      new URL(`/signin?callbackUrl=${callbackUrl}`, request.url)
    )
  }

  return NextResponse.next()
}
```

![Edge Runtime ì—ëŸ¬ í™”ë©´](/posts/20241113_nextauth.png)

## ì›ì¸ ë¶„ì„

### Edge Runtimeì˜ ì œì•½ì‚¬í•­
Next.jsì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” Edge Runtime í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. Edge Runtimeì€ ë” ë¹ ë¥¸ ì‘ë‹µ ì‹œê°„ê³¼ ê¸€ë¡œë²Œ ë°°í¬ë¥¼ ìœ„í•´ ìµœì í™”ëœ í™˜ê²½ì´ì§€ë§Œ, Node.jsì˜ ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì œì•½ì´ ìˆìŠµë‹ˆë‹¤.

ğŸ”—Â <a href="https://nextjs.org/docs/app/building-your-application/routing/middleware#runtime" target="_blank" rel="noopener noreferrer">Next.js middleware - Runtime</a>

### bcryptì˜ íŠ¹ì„±
bcryptëŠ” C++ë¡œ ì‘ì„±ëœ ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆì…ë‹ˆë‹¤. node-pre-gyp íŒ¨í‚¤ì§€ë¥¼ í†µí•´ Node.js í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë„¤ì´í‹°ë¸Œ C++ í™•ì¥ ëª¨ë“ˆì„ ì‚¬ì „ ë¹Œë“œí•˜ì—¬ ë°°í¬í•˜ëŠ”ë°, ì´ëŠ” Edge Runtimeì—ì„œ ì‹¤í–‰ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

## í•´ê²°ë°©ì•ˆ

1. bcryptjsë¡œ êµì²´
    bcryptjsëŠ” ìˆœìˆ˜ JavaScriptë¡œ ì‘ì„±ë˜ì–´ ìˆì–´ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë„ ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ bcryptì— ë¹„í•´ ì•½ 30% ì •ë„ ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.
    
    ğŸ”—Â <a href="https://github.com/dcodeIO/bcrypt.js?tab=readme-ov-file#security-considerations" target="_blank" rel="noopener noreferrer">bcrypt.js github - Security considerations</a>

2. ì„¤ì • ë¶„ë¦¬ (ì„ íƒí•œ ë°©ì•ˆ)
    bcryptë¥¼ í¬í•¨í•˜ëŠ” ì„¤ì •ì„ ë³„ë„ë¡œ ë¶„ë¦¬í•˜ì—¬ Edge Runtimeì—ì„œ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

<br />
ë‹¤ìŒì€ êµ¬ì²´ì ì¸ êµ¬í˜„ ë°©ë²•ì…ë‹ˆë‹¤.

```tsx showLineNumbers
// src/lib/auth.config.ts

// bcrpytë¥¼ ì œì™¸í•œ configë¥¼ ë¶„ë¦¬í•œë‹¤.
 const authConfig = { 
  //...
  providers: [],
 } 
```

```tsx showLineNumbers
// src/lib/auth.ts

// bcrpytë¥¼ ì œì™¸í•œ configë¥¼ importí•œë‹¤.
import { authConfig } from "@/lib/auth/auth.config"

export const { handlers, signIn, signOut, auth } = NextAuth({
	...authConfig, // ì¶”ê°€
  providers: [
    Credentials({
      credentials: {
        email: {},
        password: {},
      },
      authorize: async (credentials) => {
 
        // ì‚¬ìš©ì ì •ë³´ë¥¼ DBë¡œë¶€í„° ê°€ì ¸ì˜¤ëŠ” ë¡œì§
        const user = await getUserFromDb(credentials.email, password)
 
        if (!user) {
          throw new Error("Invalid credentials.")
        }

        return user
      },
    }),
  ],
})
```

```tsx showLineNumbers
// middleware.ts

import NextAuth from "next-auth"

// bcrpytë¥¼ ì œì™¸í•œ configë¥¼ importí•œë‹¤.
import { authConfig } from "@/lib/auth/auth.config"

const { auth } = NextAuth({ authConfig }) // NextAuthì— ì‡½!

export async function middleware(request: NextRequest) {
  const session = await auth()
  if (session?.error === "RefreshToken expired") {
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    await signOut()

    // í˜„ì¬ URLì„ stateë¡œ ì €ì¥í•˜ì—¬ ë¡œê·¸ì¸ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ìˆ˜ ìˆë„ë¡ í•¨
    const callbackUrl = encodeURIComponent(request.url)

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return NextResponse.redirect(
      new URL(`/signin?callbackUrl=${callbackUrl}`, request.url)
    )
  }

  return NextResponse.next()
}
```

## ë°°ìš´ ì 

1. **Edge Runtime ê³ ë ¤ì‚¬í•­**
    Next.jsì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‘ì„±í•  ë•ŒëŠ” Edge Runtimeì˜ ì œì•½ì‚¬í•­ì„ ë°˜ë“œì‹œ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
2. **ê³µì‹ ë¬¸ì„œì˜ ì¤‘ìš”ì„±**
    NextAuth.js ê³µì‹ ë¬¸ì„œì˜ Edge Compatibility ì„¹ì…˜ì—ì„œ ì´ë¯¸ í•´ë‹¹ ë‚´ìš©ì„ ë‹¤ë£¨ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ì „ì— ê³µì‹ ë¬¸ì„œë¥¼ ê¼¼ê¼¼íˆ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
3. **ì„¤ê³„ ê²°ì •ì˜ trade-off**
   bcryptjsë¡œì˜ êµì²´ì™€ ì„¤ì • ë¶„ë¦¬ ì¤‘ ì„±ëŠ¥ê³¼ êµ¬í˜„ ë³µì¡ë„ë¥¼ ê³ ë ¤í•˜ì—¬ ìµœì ì˜ ë°©ì•ˆì„ ì„ íƒí•´ì•¼ í–ˆìŠµë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

- [bcrypt GitHub Issue #1017](https://github.com/kelektiv/node.bcrypt.js/issues/1017)
- [NextAuth.js 15 Migration Guide - Edge Compatibility](https://authjs.dev/getting-started/migrating-to-v5#edge-compatibility)